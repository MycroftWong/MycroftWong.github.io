<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Jenkinsfile Summary | Mycroft Wong&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="This document summarizes my key learnings and experiences from writing a Jenkinsfile to implement an Android Jenkins pipeline. It highlights the challenges I encountered, the unfamiliar syntax I discovered, and other insights gained throughout the process.
1. Agent Declaration
agent any

Specifies that any available agent can execute the pipeline
Can be customized with agent tags: agent { label &#39;android-builder&#39; }

2. Environment Block
environment {
    ANDROID_HOME = &#34;/opt/android/sdk&#34;
    JAVA_HOME = &#34;/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home&#34;
    PATH = &#34;${JAVA_HOME}/bin:$PATH&#34;
    // ... other global variables
}
Serves two main purposes:">
<meta name="author" content="">
<link rel="canonical" href="https://mycroftwong.github.io/posts/jenkinsfile-summary/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://mycroftwong.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mycroftwong.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mycroftwong.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mycroftwong.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mycroftwong.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://mycroftwong.github.io/posts/jenkinsfile-summary/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://mycroftwong.github.io/posts/jenkinsfile-summary/">
  <meta property="og:site_name" content="Mycroft Wong&#39;s Blog">
  <meta property="og:title" content="Jenkinsfile Summary">
  <meta property="og:description" content="This document summarizes my key learnings and experiences from writing a Jenkinsfile to implement an Android Jenkins pipeline. It highlights the challenges I encountered, the unfamiliar syntax I discovered, and other insights gained throughout the process.
1. Agent Declaration agent any Specifies that any available agent can execute the pipeline Can be customized with agent tags: agent { label &#39;android-builder&#39; } 2. Environment Block environment { ANDROID_HOME = &#34;/opt/android/sdk&#34; JAVA_HOME = &#34;/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home&#34; PATH = &#34;${JAVA_HOME}/bin:$PATH&#34; // ... other global variables } Serves two main purposes:">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-28T09:56:41+08:00">
    <meta property="article:modified_time" content="2025-07-28T09:56:41+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jenkinsfile Summary">
<meta name="twitter:description" content="This document summarizes my key learnings and experiences from writing a Jenkinsfile to implement an Android Jenkins pipeline. It highlights the challenges I encountered, the unfamiliar syntax I discovered, and other insights gained throughout the process.
1. Agent Declaration
agent any

Specifies that any available agent can execute the pipeline
Can be customized with agent tags: agent { label &#39;android-builder&#39; }

2. Environment Block
environment {
    ANDROID_HOME = &#34;/opt/android/sdk&#34;
    JAVA_HOME = &#34;/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home&#34;
    PATH = &#34;${JAVA_HOME}/bin:$PATH&#34;
    // ... other global variables
}
Serves two main purposes:">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://mycroftwong.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Jenkinsfile Summary",
      "item": "https://mycroftwong.github.io/posts/jenkinsfile-summary/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Jenkinsfile Summary",
  "name": "Jenkinsfile Summary",
  "description": "This document summarizes my key learnings and experiences from writing a Jenkinsfile to implement an Android Jenkins pipeline. It highlights the challenges I encountered, the unfamiliar syntax I discovered, and other insights gained throughout the process.\n1. Agent Declaration agent any Specifies that any available agent can execute the pipeline Can be customized with agent tags: agent { label 'android-builder' } 2. Environment Block environment { ANDROID_HOME = \u0026#34;/opt/android/sdk\u0026#34; JAVA_HOME = \u0026#34;/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home\u0026#34; PATH = \u0026#34;${JAVA_HOME}/bin:$PATH\u0026#34; // ... other global variables } Serves two main purposes:\n",
  "keywords": [
    
  ],
  "articleBody": "This document summarizes my key learnings and experiences from writing a Jenkinsfile to implement an Android Jenkins pipeline. It highlights the challenges I encountered, the unfamiliar syntax I discovered, and other insights gained throughout the process.\n1. Agent Declaration agent any Specifies that any available agent can execute the pipeline Can be customized with agent tags: agent { label 'android-builder' } 2. Environment Block environment { ANDROID_HOME = \"/opt/android/sdk\" JAVA_HOME = \"/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home\" PATH = \"${JAVA_HOME}/bin:$PATH\" // ... other global variables } Serves two main purposes:\nModifies existing environment variables Defines global parameters shared across stages 3. Parameters Block parameters { choice(name: 'BuildType', choices: ['debug', 'release', 'aab']) booleanParam(name: 'BackupDistribution', defaultValue: true) // ... other parameters } Defines user-configurable options for the pipeline Accessed via params object in pipeline steps 4. Stages Structure stages { stage('Name') { ... } stage('Name') { ... } } Defines sequential actions Jenkins will execute Runs all stages in declared order 5. Stage Components stage('Example') { steps { // Executable steps } } Each stage requires: Unique name steps block containing executable actions script block should be inside steps 6. Variable Declaration in Steps steps { script { def myVar = 'value' // Groovy code } } Variables must be declared inside script blocks Supports complex logic and variable assignments 7. File Operations writeFile file: \"local.properties\", text: \"sdk.dir=${env.ANDROID_HOME}\" Use named parameters for clarity Supports multiple parameters: file, text, encoding 8. Conditional Stage Execution when { expression { params.BuildType == 'aab' } } Controls stage execution based on conditions Uses Groovy expressions for evaluation 9. Accessing Parameters if (params.DisableConfigurationCache) { // configuration logic } Access parameters via global params object Supports all parameter types defined in parameters block 10. Shell Command Execution def output = sh(script: \"ls -d -1 $path\", returnStdout: true).trim() def status = sh(script: \"command\", returnStatus: true) returnStdout: true captures command output returnStatus: true captures exit code Default behavior executes command without capturing output 11. File Archiving with Zip sh \"zip -j $outputPath $inputFile\" -j option stores files without directory structure Useful for creating flat archive structures 12. Post-execution Actions post { always { // Archive artifacts } } Executes after all stages complete Common uses: artifact archiving, notifications, cleanup 13. Artifact Archiving archiveArtifacts artifacts: \"$file1, $file2\", allowEmptyArchive: false artifacts parameter accepts comma-separated file paths Supports wildcards: 'build/dist/*.zip' allowEmptyArchive controls behavior when no files match Pipeline Flow Summary Environment Setup: Configures paths and global variables Preparation: Creates output directories, sets permissions Code Analysis: Runs detekt static analysis Build: Compiles APK/AAB based on build type Version Handling: Extracts version info from build outputs Artifact Management: Moves, zips, and backs up distributions Deployment: Handles Play Store uploads and QR code updates Post-processing: Archives artifacts Jenkinsfile Hereâ€™s my source Jenkinsfile:\npipeline { agent any environment { ANDROID_HOME = \"/opt/android/sdk\" JAVA_HOME = \"/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home\" PATH = \"${JAVA_HOME}/bin:$PATH\" gPackageName=\"me.mycroftwong.example\" gS3BackupUrl = \"s3://$S3_BACKUP_HOST/archive/release/example\" gPlayStorePushInternalTestJar=\"/Users/mycroft/.jenkins/uploadToInternalTest/InternalTestAab-1.0.jar\" gPlayStorePushInternalTestClientId=\"/Users/mycroft/.jenkins/uploadToInternalTest/app-internal-test-xxx.json\" gApkSrcDir = 'app/build/outputs/apk' gAabSrcDir = 'app/build/outputs/bundle/release' gOutputDir = 'build/dist' gVersionCode = '' gVersionName = '' gDistributionFile = '' gDistributionZipFile = '' } parameters { choice(name: 'BuildType', choices: ['debug', 'release', 'aab'], description: 'BuildType') booleanParam(name: 'BackupDistribution', defaultValue: true, description: 'Back up distribution') booleanParam(name: 'UpdateQrcode', defaultValue: false, description: 'Whether update qrcode') booleanParam(name: 'ReleaseCandidate', defaultValue: false, description: 'Build Release Candidate, BuildType must be release') booleanParam(name: 'PushAabToPlayStore', defaultValue: false, description: 'Whether push aab to play store, BuildType must be aab') booleanParam(name: 'DisableConfigurationCache', defaultValue: true, description: 'If not, version code may not be changed') booleanParam(name: 'EnableSyncNetDebug', defaultValue: false, description: 'If not, disable sync net debug(assert)') } stages { stage('PrepareOutputDir') { steps { sh \"mkdir -p $gOutputDir\" sh \"rm -rf $gOutputDir/*\" } } stage('PrepareLocalProperties') { steps { writeFile file: \"local.properties\", text: \"sdk.dir=${env.ANDROID_HOME}\" } } stage('AddFilePermissions') { steps { sh 'chmod +x ./gradlew' } } stage('Detekt') { steps { sh './gradlew detekt' } } stage('Build') { steps { script { def configurationCacheFlag = '' if (params.DisableConfigurationCache) { configurationCacheFlag = '--no-configuration-cache' } def enableSyncNetDebug = '' if (params.EnableSyncNetDebug) { enableSyncNetDebug = '-PenableSyncNetDebug' } if (params.BuildType == 'debug') { sh \"./gradlew clean :app:assembleDebug $configurationCacheFlag $enableSyncNetDebug\" } else if (params.BuildType == 'release') { sh \"./gradlew clean :app:assembleRelease $configurationCacheFlag $enableSyncNetDebug\" } else if (params.BuildType == 'aab') { sh \"./gradlew clean :app:bundleRelease $configurationCacheFlag $enableSyncNetDebug\" } else { throw IllegalArgumentException('Unexpected BuildType: ' + params.BuildType) } } } } stage('GetAabVersion') { when { expression { params.BuildType == 'aab' } } steps { script { def aabFile = sh(script: \"ls -d -1 $gAabSrcDir/*.aab\", returnStdout: true).trim() def versionCode = sh(script: \"bundletool dump manifest --bundle $aabFile --xpath /manifest/@android:versionCode\", returnStdout: true).trim() def versionName = sh(script: \"bundletool dump manifest --bundle $aabFile --xpath /manifest/@android:versionName\", returnStdout: true).trim() gVersionCode = versionCode gVersionName = versionName gDistributionFile = \"example-$versionName-$versionCode-${params.BuildType}.aab\" echo \"[GetAabVersion] VersionCode: $versionCode\" echo \"[GetAabVersion] VersionName: $versionName\" echo \"[GetAabVersion] DistributionFile: $gDistributionFile\" } } } stage('GetApkVersion') { when { expression { params.BuildType == 'debug' || params.BuildType == 'release' } } steps { script { def versionCode = sh(script: \"cat $gApkSrcDir/${params.BuildType}/output-metadata.json | jq \\\".elements[0].versionCode\\\"\", returnStdout: true).trim() def versionName = sh(script: \"cat $gApkSrcDir/${params.BuildType}/output-metadata.json | jq -r \\\".elements[0].versionName\\\"\", returnStdout: true).trim() gVersionCode = versionCode gVersionName = versionName gDistributionFile = \"example-$versionName-$versionCode-${params.BuildType}.apk\" echo \"[GetApkVersion] VersionCode: $versionCode\" echo \"[GetApkVersion] VersionName: $versionName\" echo \"[GetApkVersion] DistributionFile: $gDistributionFile\" } } } stage('MoveAabDistributionIntoOutputDir') { when { expression { params.BuildType == 'aab' } } steps { script { def aabFile = sh(script: \"ls -d -1 $gAabSrcDir/*.aab\", returnStdout: true).trim() sh \"cp $aabFile $gOutputDir/$gDistributionFile\" } } } stage('MoveApkDistributionIntoOutputDir') { when { expression { params.BuildType == 'debug' || params.BuildType == 'release' } } steps { script { def apkFile = sh(script: \"ls -d -1 $gApkSrcDir/${params.BuildType}/*.apk\", returnStdout: true).trim() sh \"cp $apkFile $gOutputDir/$gDistributionFile\" } } } stage('ZipDistribution') { steps { script { gDistributionZipFile = gDistributionFile.replace('.apk', '.zip').replace('.aab', '.zip') sh \"zip -j $gOutputDir/$gDistributionZipFile $gOutputDir/$gDistributionFile\" } } } stage('BackupDistribution') { when { expression { params.BackupDistribution } } steps { script { def archiveAppVersion = gVersionName.tokenize('.').take(2).join('.') if (params.ReleaseCandidate) { archiveAppVersion = archiveAppVersion + \"-RC\" } def s3Url = \"$gS3BackupUrl/$archiveAppVersion/dev/Android/\" if (params.BuildType == 'debug' \u0026\u0026 params.ReleaseCandidate) { s3Url = \"$gS3BackupUrl/$archiveAppVersion/rc/Android/\" } sh \"aws s3 cp $gOutputDir/$gDistributionZipFile $s3Url --profile bk\" } } } stage('UpdateQrcode') { when { expression { params.UpdateQrcode \u0026\u0026 params.BuildType == 'debug' } } steps { script { def archiveAppVersion = gVersionName.tokenize('.').take(2).join('.') if (params.ReleaseCandidate) { archiveAppVersion = archiveAppVersion + \"-RC\" } writeFile file: \"$gOutputDir/version.txt\", text: gVersionName sh \"aws s3 cp $gOutputDir/version.txt s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/\" sh \"aws s3 cp $gOutputDir/$gDistributionFile s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/example.apk\" sh \"node /Applications/qrCode/index.js --project=example --release=v$archiveAppVersion --android=$gVersionName\" } } } stage('PushAabToPlayStore') { when { expression { params.BuildType == 'aab' \u0026\u0026 params.PushAabToPlayStore } } steps { sh \"java -jar $gPlayStorePushInternalTestJar $gPackageName $gDistributionFile $gPlayStorePushInternalTestClientId\" } } } post { always { archiveArtifacts artifacts: \"$gOutputDir/$gDistributionZipFile, $gOutputDir/versions.txt\", allowEmptyArchive: false } } } AI make it better:\nKey Improvements Needed:\nAgent Specification: Use specific labels instead of any Credentials Handling: Avoid hardcoding secrets Environment Variables: Use withCredentials for sensitive data Stage Organization: Reduce duplication in APK/AAB handling Error Handling: Add better validation and error checking Post Actions: Improve artifact handling pipeline { agent { label 'android-agent' // Use specific agent label } environment { ANDROID_HOME = \"/opt/android/sdk\" JAVA_HOME = \"/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home\" PATH = \"${JAVA_HOME}/bin:$PATH\" gPackageName = \"me.mycroftwong.example\" gS3BackupUrl = \"s3://$S3_BACKUP_HOST/archive/release/example\" // Removed hardcoded credentials gApkSrcDir = 'app/build/outputs/apk' gAabSrcDir = 'app/build/outputs/bundle/release' gOutputDir = 'build/dist' } parameters { choice(name: 'BuildType', choices: ['debug', 'release', 'aab'], description: 'BuildType') booleanParam(name: 'BackupDistribution', defaultValue: true, description: 'Back up distribution') booleanParam(name: 'UpdateQrcode', defaultValue: false, description: 'Whether update qrcode') booleanParam(name: 'ReleaseCandidate', defaultValue: false, description: 'Build Release Candidate') booleanParam(name: 'PushAabToPlayStore', defaultValue: false, description: 'Push aab to play store') booleanParam(name: 'DisableConfigurationCache', defaultValue: true, description: 'Disable configuration cache') booleanParam(name: 'EnableSyncNetDebug', defaultValue: false, description: 'Enable sync net debug') } stages { stage('Validate Parameters') { steps { script { if (params.ReleaseCandidate \u0026\u0026 params.BuildType != 'release') { error(\"ReleaseCandidate can only be used with release build type\") } if (params.PushAabToPlayStore \u0026\u0026 params.BuildType != 'aab') { error(\"PushAabToPlayStore can only be used with aab build type\") } } } } stage('Prepare Environment') { steps { sh \"mkdir -p $gOutputDir\" sh \"rm -rf $gOutputDir/*\" writeFile file: \"local.properties\", text: \"sdk.dir=${env.ANDROID_HOME}\" sh 'chmod +x ./gradlew' } } stage('Static Analysis') { steps { sh './gradlew detekt' } } stage('Build') { steps { script { def flags = [] if (params.DisableConfigurationCache) flags \u003c\u003c '--no-configuration-cache' if (params.EnableSyncNetDebug) flags \u003c\u003c '-PenableSyncNetDebug' switch(params.BuildType) { case 'debug': sh \"./gradlew clean :app:assembleDebug ${flags.join(' ')}\" break case 'release': sh \"./gradlew clean :app:assembleRelease ${flags.join(' ')}\" break case 'aab': sh \"./gradlew clean :app:bundleRelease ${flags.join(' ')}\" break default: error(\"Invalid BuildType: ${params.BuildType}\") } } } } stage('Process Artifacts') { steps { script { // Common processing for all build types def artifactFile = \"\" def versionFile = \"\" if (params.BuildType == 'aab') { artifactFile = sh(script: \"ls -d -1 $gAabSrcDir/*.aab\", returnStdout: true).trim() env.gVersionCode = sh(script: \"bundletool dump manifest --bundle $artifactFile --xpath /manifest/@android:versionCode\", returnStdout: true).trim() env.gVersionName = sh(script: \"bundletool dump manifest --bundle $artifactFile --xpath /manifest/@android:versionName\", returnStdout: true).trim() } else { def jsonFile = \"$gApkSrcDir/${params.BuildType}/output-metadata.json\" artifactFile = sh(script: \"ls -d -1 $gApkSrcDir/${params.BuildType}/*.apk\", returnStdout: true).trim() env.gVersionCode = sh(script: \"jq -r '.elements[0].versionCode' $jsonFile\", returnStdout: true).trim() env.gVersionName = sh(script: \"jq -r '.elements[0].versionName' $jsonFile\", returnStdout: true).trim() } def ext = params.BuildType == 'aab' ? 'aab' : 'apk' env.gDistributionFile = \"example-${env.gVersionName}-${env.gVersionCode}-${params.BuildType}.${ext}\" sh \"cp $artifactFile $gOutputDir/$env.gDistributionFile\" // Zip distribution env.gDistributionZipFile = \"${env.gDistributionFile}.zip\" sh \"zip -j $gOutputDir/$env.gDistributionZipFile $gOutputDir/$env.gDistributionFile\" // Create version file writeFile file: \"$gOutputDir/versions.txt\", text: env.gVersionName } } } stage('Backup Distribution') { when { expression { params.BackupDistribution } } steps { script { def archiveAppVersion = env.gVersionName.tokenize('.').take(2).join('.') if (params.ReleaseCandidate) { archiveAppVersion += \"-RC\" } def s3Path = \"$gS3BackupUrl/$archiveAppVersion/\" s3Path += params.BuildType == 'debug' \u0026\u0026 params.ReleaseCandidate ? \"rc/Android/\" : \"dev/Android/\" sh \"aws s3 cp $gOutputDir/$env.gDistributionZipFile $s3Path --profile bk\" } } } stage('Update QR Code') { when { expression { params.UpdateQrcode \u0026\u0026 params.BuildType == 'debug' } } steps { script { def archiveAppVersion = env.gVersionName.tokenize('.').take(2).join('.') if (params.ReleaseCandidate) { archiveAppVersion += \"-RC\" } sh \"\"\" aws s3 cp $gOutputDir/versions.txt s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/ aws s3 cp $gOutputDir/$env.gDistributionFile s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/example.apk node /Applications/qrCode/index.js --project=example --release=v$archiveAppVersion --android=${env.gVersionName} \"\"\" } } } stage('Deploy to Play Store') { when { expression { params.BuildType == 'aab' \u0026\u0026 params.PushAabToPlayStore } } steps { withCredentials([ file(credentialsId: 'playstore-upload-jar', variable: 'UPLOAD_JAR'), file(credentialsId: 'playstore-service-account', variable: 'SERVICE_ACCOUNT') ]) { sh \"java -jar $UPLOAD_JAR $gPackageName $env.gDistributionFile $SERVICE_ACCOUNT\" } } } } post { always { archiveArtifacts artifacts: \"$gOutputDir/*.zip, $gOutputDir/versions.txt\", allowEmptyArchive: true } cleanup { deleteDir() // Clean up workspace } } } Key Improvements Made:\nAgent Specification:\nReplaced agent any with labeled agent for better resource management Credentials Management:\nRemoved hardcoded credentials Added withCredentials for secure credential handling Parameter Validation:\nAdded validation stage to check parameter combinations Reduced Duplication:\nCombined APK/AAB processing into a single stage Created unified artifact processing logic Environment Variables:\nProperly scoped variables using env. prefix Removed unused environment variables Improved Build Stage:\nUsed switch statement for cleaner build type handling Combined gradle flags into a single command Enhanced Post Actions:\nAdded cleanup step to delete workspace Made artifact archiving more robust with wildcards Set allowEmptyArchive: true to prevent failures Error Handling:\nAdded explicit error messages for invalid parameter combinations Improved validation of build types Security:\nRemoved all hardcoded credentials Used Jenkins credential store via withCredentials Efficiency:\nCombined related file operations Reduced number of stages while maintaining clarity ",
  "wordCount" : "1796",
  "inLanguage": "en",
  "datePublished": "2025-07-28T09:56:41+08:00",
  "dateModified": "2025-07-28T09:56:41+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mycroftwong.github.io/posts/jenkinsfile-summary/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Mycroft Wong's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mycroftwong.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mycroftwong.github.io/" accesskey="h" title="Mycroft Wong&#39;s Blog (Alt + H)">Mycroft Wong&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Jenkinsfile Summary
    </h1>
    <div class="post-meta"><span title='2025-07-28 09:56:41 +0800 +0800'>July 28, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>This document summarizes my key learnings and experiences from writing a Jenkinsfile to implement an Android Jenkins pipeline. It highlights the challenges I encountered, the unfamiliar syntax I discovered, and other insights gained throughout the process.</p>
<h2 id="1-agent-declaration">1. Agent Declaration<a hidden class="anchor" aria-hidden="true" href="#1-agent-declaration">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>agent any
</span></span></code></pre></div><ul>
<li>Specifies that any available agent can execute the pipeline</li>
<li>Can be customized with agent tags: <code>agent { label 'android-builder' }</code></li>
</ul>
<h2 id="2-environment-block">2. Environment Block<a hidden class="anchor" aria-hidden="true" href="#2-environment-block">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ANDROID_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/opt/android/sdk&#34;</span>
</span></span><span style="display:flex;"><span>    JAVA_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home&#34;</span>
</span></span><span style="display:flex;"><span>    PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${JAVA_HOME}/bin:$PATH&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... other global variables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Serves two main purposes:</p>
<ol>
<li>Modifies existing environment variables</li>
<li>Defines global parameters shared across stages</li>
</ol>
<h2 id="3-parameters-block">3. Parameters Block<a hidden class="anchor" aria-hidden="true" href="#3-parameters-block">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>parameters <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    choice<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;BuildType&#39;</span><span style="color:#f92672">,</span> choices: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;debug&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;release&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;aab&#39;</span><span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>    booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;BackupDistribution&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... other parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>Defines user-configurable options for the pipeline</li>
<li>Accessed via <code>params</code> object in pipeline steps</li>
</ul>
<h2 id="4-stages-structure">4. Stages Structure<a hidden class="anchor" aria-hidden="true" href="#4-stages-structure">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Name&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Name&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>Defines sequential actions Jenkins will execute</li>
<li>Runs all stages in declared order</li>
</ul>
<h2 id="5-stage-components">5. Stage Components<a hidden class="anchor" aria-hidden="true" href="#5-stage-components">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Example&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Executable steps
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>Each stage requires:
<ul>
<li>Unique name</li>
<li><code>steps</code> block containing executable actions</li>
</ul>
</li>
<li><code>script</code> block should be inside <code>steps</code></li>
</ul>
<h2 id="6-variable-declaration-in-steps">6. Variable Declaration in Steps<a hidden class="anchor" aria-hidden="true" href="#6-variable-declaration-in-steps">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> myVar <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;value&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Groovy code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>Variables must be declared inside <code>script</code> blocks</li>
<li>Supports complex logic and variable assignments</li>
</ul>
<h2 id="7-file-operations">7. File Operations<a hidden class="anchor" aria-hidden="true" href="#7-file-operations">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>writeFile file: <span style="color:#e6db74">&#34;local.properties&#34;</span><span style="color:#f92672">,</span> text: <span style="color:#e6db74">&#34;sdk.dir=${env.ANDROID_HOME}&#34;</span>
</span></span></code></pre></div><ul>
<li>Use named parameters for clarity</li>
<li>Supports multiple parameters: <code>file</code>, <code>text</code>, <code>encoding</code></li>
</ul>
<h2 id="8-conditional-stage-execution">8. Conditional Stage Execution<a hidden class="anchor" aria-hidden="true" href="#8-conditional-stage-execution">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>Controls stage execution based on conditions</li>
<li>Uses Groovy expressions for evaluation</li>
</ul>
<h2 id="9-accessing-parameters">9. Accessing Parameters<a hidden class="anchor" aria-hidden="true" href="#9-accessing-parameters">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">DisableConfigurationCache</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// configuration logic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>Access parameters via global <code>params</code> object</li>
<li>Supports all parameter types defined in <code>parameters</code> block</li>
</ul>
<h2 id="10-shell-command-execution">10. Shell Command Execution<a hidden class="anchor" aria-hidden="true" href="#10-shell-command-execution">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> output <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;ls -d -1 $path&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> status <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;command&#34;</span><span style="color:#f92672">,</span> returnStatus: <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><ul>
<li><code>returnStdout: true</code> captures command output</li>
<li><code>returnStatus: true</code> captures exit code</li>
<li>Default behavior executes command without capturing output</li>
</ul>
<h2 id="11-file-archiving-with-zip">11. File Archiving with Zip<a hidden class="anchor" aria-hidden="true" href="#11-file-archiving-with-zip">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>sh <span style="color:#e6db74">&#34;zip -j $outputPath $inputFile&#34;</span>
</span></span></code></pre></div><ul>
<li><code>-j</code> option stores files without directory structure</li>
<li>Useful for creating flat archive structures</li>
</ul>
<h2 id="12-post-execution-actions">12. Post-execution Actions<a hidden class="anchor" aria-hidden="true" href="#12-post-execution-actions">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    always <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Archive artifacts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>Executes after all stages complete</li>
<li>Common uses: artifact archiving, notifications, cleanup</li>
</ul>
<h2 id="13-artifact-archiving">13. Artifact Archiving<a hidden class="anchor" aria-hidden="true" href="#13-artifact-archiving">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>archiveArtifacts artifacts: <span style="color:#e6db74">&#34;$file1, $file2&#34;</span><span style="color:#f92672">,</span> allowEmptyArchive: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><ul>
<li><code>artifacts</code> parameter accepts comma-separated file paths</li>
<li>Supports wildcards: <code>'build/dist/*.zip'</code></li>
<li><code>allowEmptyArchive</code> controls behavior when no files match</li>
</ul>
<h2 id="pipeline-flow-summary">Pipeline Flow Summary<a hidden class="anchor" aria-hidden="true" href="#pipeline-flow-summary">#</a></h2>
<ol>
<li><strong>Environment Setup</strong>: Configures paths and global variables</li>
<li><strong>Preparation</strong>: Creates output directories, sets permissions</li>
<li><strong>Code Analysis</strong>: Runs detekt static analysis</li>
<li><strong>Build</strong>: Compiles APK/AAB based on build type</li>
<li><strong>Version Handling</strong>: Extracts version info from build outputs</li>
<li><strong>Artifact Management</strong>: Moves, zips, and backs up distributions</li>
<li><strong>Deployment</strong>: Handles Play Store uploads and QR code updates</li>
<li><strong>Post-processing</strong>: Archives artifacts</li>
</ol>
<h2 id="jenkinsfile">Jenkinsfile<a hidden class="anchor" aria-hidden="true" href="#jenkinsfile">#</a></h2>
<p>Here&rsquo;s my source Jenkinsfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ANDROID_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/opt/android/sdk&#34;</span>
</span></span><span style="display:flex;"><span>        JAVA_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home&#34;</span>
</span></span><span style="display:flex;"><span>        PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${JAVA_HOME}/bin:$PATH&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gPackageName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;me.mycroftwong.example&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gS3BackupUrl <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;s3://$S3_BACKUP_HOST/archive/release/example&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gPlayStorePushInternalTestJar<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Users/mycroft/.jenkins/uploadToInternalTest/InternalTestAab-1.0.jar&#34;</span>
</span></span><span style="display:flex;"><span>        gPlayStorePushInternalTestClientId<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Users/mycroft/.jenkins/uploadToInternalTest/app-internal-test-xxx.json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gApkSrcDir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;app/build/outputs/apk&#39;</span>
</span></span><span style="display:flex;"><span>        gAabSrcDir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;app/build/outputs/bundle/release&#39;</span>
</span></span><span style="display:flex;"><span>        gOutputDir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;build/dist&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gVersionCode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        gVersionName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        gDistributionFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        gDistributionZipFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parameters <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        choice<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;BuildType&#39;</span><span style="color:#f92672">,</span> choices: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;debug&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;release&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;aab&#39;</span><span style="color:#f92672">],</span> description: <span style="color:#e6db74">&#39;BuildType&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;BackupDistribution&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Back up distribution&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;UpdateQrcode&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Whether update qrcode&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;ReleaseCandidate&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Build Release Candidate, BuildType must be release&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;PushAabToPlayStore&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Whether push aab to play store, BuildType must be aab&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;DisableConfigurationCache&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;If not, version code may not be changed&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;EnableSyncNetDebug&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;If not, disable sync net debug(assert)&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;PrepareOutputDir&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;mkdir -p $gOutputDir&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;rm -rf $gOutputDir/*&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;PrepareLocalProperties&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                writeFile file: <span style="color:#e6db74">&#34;local.properties&#34;</span><span style="color:#f92672">,</span> text: <span style="color:#e6db74">&#34;sdk.dir=${env.ANDROID_HOME}&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;AddFilePermissions&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;chmod +x ./gradlew&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Detekt&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;./gradlew detekt&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Build&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> configurationCacheFlag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">DisableConfigurationCache</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        configurationCacheFlag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;--no-configuration-cache&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> enableSyncNetDebug <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">EnableSyncNetDebug</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        enableSyncNetDebug <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;-PenableSyncNetDebug&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;debug&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;./gradlew clean :app:assembleDebug $configurationCacheFlag $enableSyncNetDebug&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;release&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;./gradlew clean :app:assembleRelease $configurationCacheFlag $enableSyncNetDebug&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        sh <span style="color:#e6db74">&#34;./gradlew clean :app:bundleRelease $configurationCacheFlag $enableSyncNetDebug&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#a6e22e">IllegalArgumentException</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Unexpected BuildType: &#39;</span> <span style="color:#f92672">+</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;GetAabVersion&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> aabFile <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;ls -d -1 $gAabSrcDir/*.aab&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> versionCode <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;bundletool dump manifest --bundle $aabFile --xpath /manifest/@android:versionCode&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> versionName <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;bundletool dump manifest --bundle $aabFile --xpath /manifest/@android:versionName&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    gVersionCode <span style="color:#f92672">=</span> versionCode
</span></span><span style="display:flex;"><span>                    gVersionName <span style="color:#f92672">=</span> versionName
</span></span><span style="display:flex;"><span>                    gDistributionFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;example-$versionName-$versionCode-${params.BuildType}.aab&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;[GetAabVersion] VersionCode: $versionCode&#34;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;[GetAabVersion] VersionName: $versionName&#34;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;[GetAabVersion] DistributionFile: $gDistributionFile&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;GetApkVersion&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;debug&#39;</span> <span style="color:#f92672">||</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;release&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> versionCode <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;cat $gApkSrcDir/${params.BuildType}/output-metadata.json | jq \&#34;.elements[0].versionCode\&#34;&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> versionName <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;cat $gApkSrcDir/${params.BuildType}/output-metadata.json | jq -r \&#34;.elements[0].versionName\&#34;&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    gVersionCode <span style="color:#f92672">=</span> versionCode
</span></span><span style="display:flex;"><span>                    gVersionName <span style="color:#f92672">=</span> versionName
</span></span><span style="display:flex;"><span>                    gDistributionFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;example-$versionName-$versionCode-${params.BuildType}.apk&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;[GetApkVersion] VersionCode: $versionCode&#34;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;[GetApkVersion] VersionName: $versionName&#34;</span>
</span></span><span style="display:flex;"><span>                    echo <span style="color:#e6db74">&#34;[GetApkVersion] DistributionFile: $gDistributionFile&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;MoveAabDistributionIntoOutputDir&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> aabFile <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;ls -d -1 $gAabSrcDir/*.aab&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;cp $aabFile $gOutputDir/$gDistributionFile&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;MoveApkDistributionIntoOutputDir&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;debug&#39;</span> <span style="color:#f92672">||</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;release&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> apkFile <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;ls -d -1 $gApkSrcDir/${params.BuildType}/*.apk&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;cp $apkFile $gOutputDir/$gDistributionFile&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;ZipDistribution&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    gDistributionZipFile <span style="color:#f92672">=</span> gDistributionFile<span style="color:#f92672">.</span><span style="color:#a6e22e">replace</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.apk&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;.zip&#39;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">replace</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.aab&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;.zip&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;zip -j $gOutputDir/$gDistributionZipFile $gOutputDir/$gDistributionFile&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;BackupDistribution&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">BackupDistribution</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> archiveAppVersion <span style="color:#f92672">=</span> gVersionName<span style="color:#f92672">.</span><span style="color:#a6e22e">tokenize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">take</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">).</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">ReleaseCandidate</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        archiveAppVersion <span style="color:#f92672">=</span> archiveAppVersion <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-RC&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> s3Url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$gS3BackupUrl/$archiveAppVersion/dev/Android/&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;debug&#39;</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">ReleaseCandidate</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        s3Url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$gS3BackupUrl/$archiveAppVersion/rc/Android/&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;aws s3 cp $gOutputDir/$gDistributionZipFile $s3Url --profile bk&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;UpdateQrcode&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">UpdateQrcode</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> archiveAppVersion <span style="color:#f92672">=</span> gVersionName<span style="color:#f92672">.</span><span style="color:#a6e22e">tokenize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">take</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">).</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">ReleaseCandidate</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        archiveAppVersion <span style="color:#f92672">=</span> archiveAppVersion <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-RC&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    writeFile file: <span style="color:#e6db74">&#34;$gOutputDir/version.txt&#34;</span><span style="color:#f92672">,</span> text: gVersionName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;aws s3 cp $gOutputDir/version.txt s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/&#34;</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;aws s3 cp $gOutputDir/$gDistributionFile s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/example.apk&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;node /Applications/qrCode/index.js --project=example --release=v$archiveAppVersion --android=$gVersionName&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;PushAabToPlayStore&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">PushAabToPlayStore</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;java -jar $gPlayStorePushInternalTestJar $gPackageName $gDistributionFile $gPlayStorePushInternalTestClientId&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            archiveArtifacts artifacts: <span style="color:#e6db74">&#34;$gOutputDir/$gDistributionZipFile, $gOutputDir/versions.txt&#34;</span><span style="color:#f92672">,</span> allowEmptyArchive: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>AI make it better:</p>
<p>Key Improvements Needed:</p>
<ol>
<li><strong>Agent Specification</strong>: Use specific labels instead of <code>any</code></li>
<li><strong>Credentials Handling</strong>: Avoid hardcoding secrets</li>
<li><strong>Environment Variables</strong>: Use <code>withCredentials</code> for sensitive data</li>
<li><strong>Stage Organization</strong>: Reduce duplication in APK/AAB handling</li>
<li><strong>Error Handling</strong>: Add better validation and error checking</li>
<li><strong>Post Actions</strong>: Improve artifact handling</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    agent <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        label <span style="color:#e6db74">&#39;android-agent&#39;</span> <span style="color:#75715e">// Use specific agent label
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    environment <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ANDROID_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/opt/android/sdk&#34;</span>
</span></span><span style="display:flex;"><span>        JAVA_HOME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/Library/Java/OpenJDK/jdk-18.0.2.jdk/Contents/Home&#34;</span>
</span></span><span style="display:flex;"><span>        PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${JAVA_HOME}/bin:$PATH&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gPackageName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;me.mycroftwong.example&#34;</span>
</span></span><span style="display:flex;"><span>        gS3BackupUrl <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;s3://$S3_BACKUP_HOST/archive/release/example&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Removed hardcoded credentials
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        gApkSrcDir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;app/build/outputs/apk&#39;</span>
</span></span><span style="display:flex;"><span>        gAabSrcDir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;app/build/outputs/bundle/release&#39;</span>
</span></span><span style="display:flex;"><span>        gOutputDir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;build/dist&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parameters <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        choice<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;BuildType&#39;</span><span style="color:#f92672">,</span> choices: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;debug&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;release&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;aab&#39;</span><span style="color:#f92672">],</span> description: <span style="color:#e6db74">&#39;BuildType&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;BackupDistribution&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Back up distribution&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;UpdateQrcode&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Whether update qrcode&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;ReleaseCandidate&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Build Release Candidate&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;PushAabToPlayStore&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Push aab to play store&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;DisableConfigurationCache&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Disable configuration cache&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        booleanParam<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;EnableSyncNetDebug&#39;</span><span style="color:#f92672">,</span> defaultValue: <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> description: <span style="color:#e6db74">&#39;Enable sync net debug&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stages <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Validate Parameters&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">ReleaseCandidate</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;release&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ReleaseCandidate can only be used with release build type&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">PushAabToPlayStore</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;aab&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;PushAabToPlayStore can only be used with aab build type&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Prepare Environment&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;mkdir -p $gOutputDir&#34;</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#34;rm -rf $gOutputDir/*&#34;</span>
</span></span><span style="display:flex;"><span>                writeFile file: <span style="color:#e6db74">&#34;local.properties&#34;</span><span style="color:#f92672">,</span> text: <span style="color:#e6db74">&#34;sdk.dir=${env.ANDROID_HOME}&#34;</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;chmod +x ./gradlew&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Static Analysis&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sh <span style="color:#e6db74">&#39;./gradlew detekt&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Build&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> flags <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">DisableConfigurationCache</span><span style="color:#f92672">)</span> flags <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;--no-configuration-cache&#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">EnableSyncNetDebug</span><span style="color:#f92672">)</span> flags <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;-PenableSyncNetDebug&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">switch</span><span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;debug&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                            sh <span style="color:#e6db74">&#34;./gradlew clean :app:assembleDebug ${flags.join(&#39; &#39;)}&#34;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;release&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                            sh <span style="color:#e6db74">&#34;./gradlew clean :app:assembleRelease ${flags.join(&#39; &#39;)}&#34;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;aab&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                            sh <span style="color:#e6db74">&#34;./gradlew clean :app:bundleRelease ${flags.join(&#39; &#39;)}&#34;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                            error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Invalid BuildType: ${params.BuildType}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Process Artifacts&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Common processing for all build types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">def</span> artifactFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> versionFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        artifactFile <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;ls -d -1 $gAabSrcDir/*.aab&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                        env<span style="color:#f92672">.</span><span style="color:#a6e22e">gVersionCode</span> <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;bundletool dump manifest --bundle $artifactFile --xpath /manifest/@android:versionCode&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                        env<span style="color:#f92672">.</span><span style="color:#a6e22e">gVersionName</span> <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;bundletool dump manifest --bundle $artifactFile --xpath /manifest/@android:versionName&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">def</span> jsonFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$gApkSrcDir/${params.BuildType}/output-metadata.json&#34;</span>
</span></span><span style="display:flex;"><span>                        artifactFile <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;ls -d -1 $gApkSrcDir/${params.BuildType}/*.apk&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                        env<span style="color:#f92672">.</span><span style="color:#a6e22e">gVersionCode</span> <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;jq -r &#39;.elements[0].versionCode&#39; $jsonFile&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                        env<span style="color:#f92672">.</span><span style="color:#a6e22e">gVersionName</span> <span style="color:#f92672">=</span> sh<span style="color:#f92672">(</span>script: <span style="color:#e6db74">&#34;jq -r &#39;.elements[0].versionName&#39; $jsonFile&#34;</span><span style="color:#f92672">,</span> returnStdout: <span style="color:#66d9ef">true</span><span style="color:#f92672">).</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> ext <span style="color:#f92672">=</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;aab&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;apk&#39;</span>
</span></span><span style="display:flex;"><span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">gDistributionFile</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;example-${env.gVersionName}-${env.gVersionCode}-${params.BuildType}.${ext}&#34;</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;cp $artifactFile $gOutputDir/$env.gDistributionFile&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Zip distribution
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    env<span style="color:#f92672">.</span><span style="color:#a6e22e">gDistributionZipFile</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${env.gDistributionFile}.zip&#34;</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;zip -j $gOutputDir/$env.gDistributionZipFile $gOutputDir/$env.gDistributionFile&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Create version file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    writeFile file: <span style="color:#e6db74">&#34;$gOutputDir/versions.txt&#34;</span><span style="color:#f92672">,</span> text: env<span style="color:#f92672">.</span><span style="color:#a6e22e">gVersionName</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Backup Distribution&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BackupDistribution</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> archiveAppVersion <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">gVersionName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tokenize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">take</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">).</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">ReleaseCandidate</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        archiveAppVersion <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;-RC&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> s3Path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$gS3BackupUrl/$archiveAppVersion/&#34;</span>
</span></span><span style="display:flex;"><span>                    s3Path <span style="color:#f92672">+=</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;debug&#39;</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">ReleaseCandidate</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;rc/Android/&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;dev/Android/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;aws s3 cp $gOutputDir/$env.gDistributionZipFile $s3Path --profile bk&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Update QR Code&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">UpdateQrcode</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">def</span> archiveAppVersion <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span><span style="color:#a6e22e">gVersionName</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tokenize</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">take</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">).</span><span style="color:#a6e22e">join</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">ReleaseCandidate</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        archiveAppVersion <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;-RC&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        aws s3 cp $gOutputDir/versions.txt s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        aws s3 cp $gOutputDir/$env.gDistributionFile s3://example-storage/Testing/example/QRCodeDownload/v$archiveAppVersion/example.apk
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        node /Applications/qrCode/index.js --project=example --release=v$archiveAppVersion --android=${env.gVersionName}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Deploy to Play Store&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            when <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                expression <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    params<span style="color:#f92672">.</span><span style="color:#a6e22e">BuildType</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;aab&#39;</span> <span style="color:#f92672">&amp;&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">PushAabToPlayStore</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            steps <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                withCredentials<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>                    file<span style="color:#f92672">(</span>credentialsId: <span style="color:#e6db74">&#39;playstore-upload-jar&#39;</span><span style="color:#f92672">,</span> variable: <span style="color:#e6db74">&#39;UPLOAD_JAR&#39;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>                    file<span style="color:#f92672">(</span>credentialsId: <span style="color:#e6db74">&#39;playstore-service-account&#39;</span><span style="color:#f92672">,</span> variable: <span style="color:#e6db74">&#39;SERVICE_ACCOUNT&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sh <span style="color:#e6db74">&#34;java -jar $UPLOAD_JAR $gPackageName $env.gDistributionFile $SERVICE_ACCOUNT&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        always <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            archiveArtifacts artifacts: <span style="color:#e6db74">&#34;$gOutputDir/*.zip, $gOutputDir/versions.txt&#34;</span><span style="color:#f92672">,</span> allowEmptyArchive: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        cleanup <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            deleteDir<span style="color:#f92672">()</span> <span style="color:#75715e">// Clean up workspace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Key Improvements Made:</p>
<ol>
<li>
<p><strong>Agent Specification</strong>:</p>
<ul>
<li>Replaced <code>agent any</code> with labeled agent for better resource management</li>
</ul>
</li>
<li>
<p><strong>Credentials Management</strong>:</p>
<ul>
<li>Removed hardcoded credentials</li>
<li>Added <code>withCredentials</code> for secure credential handling</li>
</ul>
</li>
<li>
<p><strong>Parameter Validation</strong>:</p>
<ul>
<li>Added validation stage to check parameter combinations</li>
</ul>
</li>
<li>
<p><strong>Reduced Duplication</strong>:</p>
<ul>
<li>Combined APK/AAB processing into a single stage</li>
<li>Created unified artifact processing logic</li>
</ul>
</li>
<li>
<p><strong>Environment Variables</strong>:</p>
<ul>
<li>Properly scoped variables using <code>env.</code> prefix</li>
<li>Removed unused environment variables</li>
</ul>
</li>
<li>
<p><strong>Improved Build Stage</strong>:</p>
<ul>
<li>Used switch statement for cleaner build type handling</li>
<li>Combined gradle flags into a single command</li>
</ul>
</li>
<li>
<p><strong>Enhanced Post Actions</strong>:</p>
<ul>
<li>Added <code>cleanup</code> step to delete workspace</li>
<li>Made artifact archiving more robust with wildcards</li>
<li>Set <code>allowEmptyArchive: true</code> to prevent failures</li>
</ul>
</li>
<li>
<p><strong>Error Handling</strong>:</p>
<ul>
<li>Added explicit error messages for invalid parameter combinations</li>
<li>Improved validation of build types</li>
</ul>
</li>
<li>
<p><strong>Security</strong>:</p>
<ul>
<li>Removed all hardcoded credentials</li>
<li>Used Jenkins credential store via <code>withCredentials</code></li>
</ul>
</li>
<li>
<p><strong>Efficiency</strong>:</p>
<ul>
<li>Combined related file operations</li>
<li>Reduced number of stages while maintaining clarity</li>
</ul>
</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://mycroftwong.github.io/">Mycroft Wong&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
